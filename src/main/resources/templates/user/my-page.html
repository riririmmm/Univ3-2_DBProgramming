<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë§ˆì´í˜ì´ì§€</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 1000px; margin: 40px auto; }
        h1 { font-size: 28px; margin-bottom: 20px; }
        h2 { margin-top: 30px; }

        /* ì±… ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ */
        #my-books {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin: 0;
            padding: 0;
            list-style: none;
        }
        .book-card {
            width: 140px;
            cursor: pointer;
            border-radius: 8px;
            border: 1px solid #eee;
            padding: 8px;
            box-sizing: border-box;
            text-align: center;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }
        .book-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }
        .book-cover {
            width: 100%;
            height: 190px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 6px;
        }
        .book-title {
            font-size: 13px;
            font-weight: 600;
            line-height: 1.3;
        }

        /* ê³µí†µ ë¦¬ìŠ¤íŠ¸ / í…ìŠ¤íŠ¸ */
        ul { list-style: none; padding-left: 0; }
        li { padding: 8px 0; border-bottom: 1px solid #eee; }

        /* ëª¨ë‹¬ */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-backdrop.show {
            display: flex;
        }
        .modal {
            background: white;
            width: 500px;
            max-height: 80vh;
            border-radius: 10px;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        .modal-close {
            border: none;
            background: none;
            font-size: 18px;
            cursor: pointer;
        }
        .modal-section-title {
            font-size: 14px;
            font-weight: 600;
            margin-top: 12px;
            margin-bottom: 4px;
        }
        .modal-review-item {
            border-top: 1px solid #eee;
            padding: 10px 0;
        }
        .modal-review-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
    </style>
</head>

<body>
<h1 th:text="'ë§ˆì´í˜ì´ì§€ - ' + ${nickname}">ë§ˆì´í˜ì´ì§€</h1>

<section>
    <h2>ğŸ“š ë‚´ê°€ ë¦¬ë·° ì“´ ì±…ë“¤</h2>
    <ul id="my-books">
        <li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
    </ul>
</section>

<!-- ëª¨ë‹¬: ì±… í´ë¦­ ì‹œ ë‚´ ë¦¬ë·° + ì½”ë©˜íŠ¸ í‘œì‹œ -->
<div id="review-modal-backdrop" class="modal-backdrop">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title" id="modal-book-title">ì±… ì œëª©</div>
            <button class="modal-close" onclick="closeModal()">âœ•</button>
        </div>

        <div id="modal-book-link" style="margin-bottom:8px; font-size: 13px;"></div>

        <div class="modal-section-title">ğŸ“ ë‚´ê°€ ë‚¨ê¸´ ë¦¬ë·°</div>
        <div id="modal-reviews"></div>

        <div class="modal-section-title" style="margin-top:16px;">ğŸ’¬ ë‚´ê°€ ë‚¨ê¸´ í˜ì´ì§€ ì½”ë©˜íŠ¸</div>
        <div id="modal-comments"></div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        loadMyBooks();
    });

    // 1) ì¹´ë“œë¡œ ì±… ëª©ë¡ í‘œì‹œ
    async function loadMyBooks() {
        const container = document.getElementById("my-books");
        container.innerHTML = "";

        const res = await fetch("/api/me/books");
        if (!res.ok) {
            container.innerHTML = "<li>ì±… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>";
            return;
        }
        const books = await res.json();   // [{ isbn13: "..." }, ...]

        if (books.length === 0) {
            container.innerHTML = "<li>ë¦¬ë·°ë¥¼ ë‚¨ê¸´ ì±…ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</li>";
            return;
        }

        for (const b of books) {
            const li = document.createElement("li");
            li.className = "book-card";

            try {
                // ì±… ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì œëª©/í‘œì§€)
                const detailRes = await fetch(`/api/books/${b.isbn13}`);
                if (!detailRes.ok) continue;
                const book = await detailRes.json();   // BookView

                const img = document.createElement("img");
                img.className = "book-cover";
                img.src = book.coverUrl || "";
                img.alt = book.title;

                const titleDiv = document.createElement("div");
                titleDiv.className = "book-title";
                titleDiv.textContent = book.title || b.isbn13;

                li.appendChild(img);
                li.appendChild(titleDiv);

                li.onclick = () => openBookModal(b.isbn13, book.title || b.isbn13);

                container.appendChild(li);
            } catch (e) {
                console.error("ì±… ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨", e);
            }
        }
    }

    // 2) ëª¨ë‹¬ ì—´ê¸°: í•´ë‹¹ ì±…ì— ëŒ€í•´ ë‚´ê°€ ì“´ ë¦¬ë·° + ì½”ë©˜íŠ¸
    async function openBookModal(isbn13, title) {
        const backdrop  = document.getElementById("review-modal-backdrop");
        const titleEl   = document.getElementById("modal-book-title");
        const linkEl    = document.getElementById("modal-book-link");
        const reviewEl  = document.getElementById("modal-reviews");
        const commentEl = document.getElementById("modal-comments");

        titleEl.textContent = title;
        linkEl.innerHTML = `<a href="/books/${isbn13}">ë„ì„œ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™</a>`;

        reviewEl.innerHTML  = "ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
        commentEl.innerHTML = "ì½”ë©˜íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

        // ë™ì‹œì— í˜¸ì¶œ
        const [reviewRes, commentRes] = await Promise.all([
            fetch(`/api/me/books/${isbn13}/reviews`),
            fetch(`/api/me/books/${isbn13}/page-comments`)
        ]);

        // --- ë¦¬ë·° í‘œì‹œ ---
        if (!reviewRes.ok) {
            reviewEl.textContent = "ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
        } else {
            const reviews = await reviewRes.json();
            if (reviews.length === 0) {
                reviewEl.textContent = "ì´ ì±…ì— ë‚¨ê¸´ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.";
            } else {
                reviewEl.innerHTML = "";
                for (const r of reviews) {
                    const div = document.createElement("div");
                    div.className = "modal-review-item";

                    const meta = document.createElement("div");
                    meta.className = "modal-review-meta";
                    meta.textContent =
                        `í‰ì : ${r.rating ?? '-'} | ìŠ¤í¬ì¼ëŸ¬: ${r.spoiler ? 'O' : 'X'} | ì‘ì„±ì¼: ${r.createdAt ?? ''}`;

                    const body = document.createElement("div");
                    body.textContent = r.overall;

                    div.appendChild(meta);
                    div.appendChild(body);
                    reviewEl.appendChild(div);
                }
            }
        }

        // --- ì½”ë©˜íŠ¸ í‘œì‹œ ---
        if (!commentRes.ok) {
            commentEl.textContent = "ì½”ë©˜íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
        } else {
            const comments = await commentRes.json(); // MyPageCommentResponse[]
            if (comments.length === 0) {
                commentEl.textContent = "ì´ ì±…ì— ë‚¨ê¸´ ì½”ë©˜íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.";
            } else {
                commentEl.innerHTML = "";
                for (const c of comments) {
                    const div = document.createElement("div");
                    div.className = "modal-review-item";

                    const meta = document.createElement("div");
                    meta.className = "modal-review-meta";
                    meta.textContent =
                        `p.${c.page} | ì‘ì„±ì¼: ${c.createdAt ?? ''}`;

                    const body = document.createElement("div");
                    body.textContent = c.comment;

                    div.appendChild(meta);
                    div.appendChild(body);
                    commentEl.appendChild(div);
                }
            }
        }

        backdrop.classList.add("show");
    }

    function closeModal() {
        document.getElementById("review-modal-backdrop").classList.remove("show");
    }
</script>
</body>
</html>
