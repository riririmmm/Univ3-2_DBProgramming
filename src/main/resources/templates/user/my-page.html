<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë§ˆì´í˜ì´ì§€</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 1000px; margin: 40px auto; }
        h1 { font-size: 28px; margin-bottom: 20px; }
        h2 { margin-top: 30px; }

        /* ì±… ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ */
        #my-books {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin: 0;
            padding: 0;
            list-style: none;
        }
        .book-card {
            width: 140px;
            cursor: pointer;
            border-radius: 8px;
            border: 1px solid #eee;
            padding: 8px;
            box-sizing: border-box;
            text-align: center;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }
        .book-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }
        .book-cover {
            width: 100%;
            height: 190px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 6px;
        }
        .book-title {
            font-size: 13px;
            font-weight: 600;
            line-height: 1.3;
        }

        /* ì•„ë˜ ê¸°ì¡´ ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ì€ ê·¸ëŒ€ë¡œ */
        ul { list-style: none; padding-left: 0; }
        li { padding: 8px 0; border-bottom: 1px solid #eee; }
        .review-item { display: flex; flex-direction: column; gap: 4px; }
        .review-meta { font-size: 12px; color: #666; }
        .actions button { margin-right: 6px; font-size: 12px; }
        .book-link { text-decoration: none; color: #0366d6; }

        /* ëª¨ë‹¬ */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-backdrop.show {
            display: flex;
        }
        .modal {
            background: white;
            width: 500px;
            max-height: 80vh;
            border-radius: 10px;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        .modal-close {
            border: none;
            background: none;
            font-size: 18px;
            cursor: pointer;
        }
        .modal-review-item {
            border-top: 1px solid #eee;
            padding: 10px 0;
        }
        .modal-review-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
    </style>
</head>
<body>
<h1 th:text="'ë§ˆì´í˜ì´ì§€ - ' + ${nickname}">ë§ˆì´í˜ì´ì§€</h1>

<section>
    <h2>ğŸ“š ë‚´ê°€ ë¦¬ë·° ì“´ ì±…ë“¤</h2>
    <ul id="my-books">
        <li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
    </ul>
</section>

<!-- ëª¨ë‹¬: ì±… í´ë¦­ ì‹œ ë‚´ ë¦¬ë·° í‘œì‹œ -->
<div id="review-modal-backdrop" class="modal-backdrop">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title" id="modal-book-title">ì±… ì œëª©</div>
            <button class="modal-close" onclick="closeModal()">âœ•</button>
        </div>
        <div id="modal-book-link" style="margin-bottom:8px; font-size: 13px;">
            <!-- ë„ì„œ ìƒì„¸ í˜ì´ì§€ ë§í¬ -->
        </div>
        <div id="modal-reviews">
            <!-- ì´ ì±…ì— ëŒ€í•´ ë‚´ê°€ ì“´ ë¦¬ë·°ë“¤ì´ ë“¤ì–´ê° -->
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        loadMyBooks();
        loadMyReviews();
    });

    // 1) ì¹´ë“œë¡œ ì±… ëª©ë¡ í‘œì‹œ
    async function loadMyBooks() {
        const container = document.getElementById("my-books");
        container.innerHTML = "";

        const res = await fetch("/api/me/books");
        if (!res.ok) {
            container.innerHTML = "<li>ì±… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>";
            return;
        }
        const books = await res.json();   // [{ isbn13: "..." }, ...]

        if (books.length === 0) {
            container.innerHTML = "<li>ë¦¬ë·°ë¥¼ ë‚¨ê¸´ ì±…ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</li>";
            return;
        }

        for (const b of books) {
            const li = document.createElement("li");
            li.className = "book-card";

            try {
                // ì±… ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì œëª©/í‘œì§€)
                const detailRes = await fetch(`/api/books/${b.isbn13}`);
                if (!detailRes.ok) continue;
                const book = await detailRes.json();   // BookView

                const img = document.createElement("img");
                img.className = "book-cover";
                img.src = book.coverUrl || "";
                img.alt = book.title;

                const titleDiv = document.createElement("div");
                titleDiv.className = "book-title";
                titleDiv.textContent = book.title || b.isbn13;

                li.appendChild(img);
                li.appendChild(titleDiv);

                li.onclick = () => openBookModal(b.isbn13, book.title || b.isbn13);

                container.appendChild(li);
            } catch (e) {
                console.error("ì±… ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨", e);
            }
        }
    }

    // 2) ì „ì²´ ë¦¬ë·° ëª©ë¡ (ì§€ê¸ˆ ìˆë˜ ì½”ë“œ ê·¸ëŒ€ë¡œ ìœ ì§€)
    async function loadMyReviews() {
        const ul = document.getElementById("my-reviews");
        ul.innerHTML = "";

        const res = await fetch("/api/me/reviews");
        if (!res.ok) {
            ul.innerHTML = "<li>ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>";
            return;
        }
        const reviews = await res.json();

        if (reviews.length === 0) {
            ul.innerHTML = "<li>ì‘ì„±í•œ ì´í‰ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</li>";
            return;
        }

        for (const r of reviews) {
            const li = document.createElement("li");
            li.className = "review-item";

            const meta = document.createElement("div");
            meta.className = "review-meta";
            meta.textContent = `ISBN: ${r.isbn13} | í‰ì : ${r.rating ?? '-'} | ìŠ¤í¬ì¼ëŸ¬: ${r.spoiler ? 'O' : 'X'}`;

            const text = document.createElement("div");
            text.textContent = r.overall;

            const actions = document.createElement("div");
            actions.className = "actions";

            const editBtn = document.createElement("button");
            editBtn.textContent = "ìˆ˜ì •";
            editBtn.onclick = () => editReview(r);

            const delBtn = document.createElement("button");
            delBtn.textContent = "ì‚­ì œ";
            delBtn.onclick = () => deleteReview(r.id);

            actions.appendChild(editBtn);
            actions.appendChild(delBtn);

            li.appendChild(meta);
            li.appendChild(text);
            li.appendChild(actions);

            ul.appendChild(li);
        }
    }

    async function editReview(r) {
        const newText = prompt("ìƒˆ ì´í‰ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:", r.overall);
        if (newText == null) return;

        const newRatingStr = prompt("ìƒˆ í‰ì (1~5, ë¹ˆì¹¸ì´ë©´ ê·¸ëŒ€ë¡œ):", r.rating ?? "");
        let newRating = r.rating;
        if (newRatingStr !== null && newRatingStr.trim() !== "") {
            newRating = Number(newRatingStr);
        }

        const newSpoilerStr = prompt("ìŠ¤í¬ì¼ëŸ¬ ì—¬ë¶€ (y/n, ë¹ˆì¹¸ì´ë©´ ê·¸ëŒ€ë¡œ):", r.spoiler ? "y" : "n");
        let newSpoiler = r.spoiler;
        if (newSpoilerStr !== null && newSpoilerStr.trim() !== "") {
            newSpoiler = newSpoilerStr.toLowerCase().startsWith("y");
        }

        const res = await fetch(`/api/me/reviews/${r.id}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                rating: newRating,
                overall: newText,
                spoiler: newSpoiler
            })
        });

        if (!res.ok) {
            alert("ë¦¬ë·° ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            return;
        }

        await loadMyReviews();
    }

    async function deleteReview(id) {
        if (!confirm("ì´ ì´í‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const res = await fetch(`/api/me/reviews/${id}`, { method: "DELETE" });
        if (!res.ok) {
            alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            return;
        }

        await loadMyReviews();
    }

    // 3) ëª¨ë‹¬ ì—´ê¸°: í•´ë‹¹ ì±…ì— ëŒ€í•´ ë‚´ê°€ ì“´ ë¦¬ë·°ë§Œ
    async function openBookModal(isbn13, title) {
        const backdrop = document.getElementById("review-modal-backdrop");
        const titleEl = document.getElementById("modal-book-title");
        const linkEl = document.getElementById("modal-book-link");
        const listEl = document.getElementById("modal-reviews");

        titleEl.textContent = title;
        linkEl.innerHTML = `<a href="/books/${isbn13}">ë„ì„œ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™</a>`;
        listEl.innerHTML = "ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

        const res = await fetch(`/api/me/books/${isbn13}/reviews`);
        if (!res.ok) {
            listEl.textContent = "ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
            backdrop.classList.add("show");
            return;
        }

        const reviews = await res.json(); // MyReviewResponse[]
        if (reviews.length === 0) {
            listEl.textContent = "ì´ ì±…ì— ë‚¨ê¸´ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.";
            backdrop.classList.add("show");
            return;
        }

        listEl.innerHTML = "";
        for (const r of reviews) {
            const div = document.createElement("div");
            div.className = "modal-review-item";

            const meta = document.createElement("div");
            meta.className = "modal-review-meta";
            meta.textContent = `í‰ì : ${r.rating ?? '-'} | ìŠ¤í¬ì¼ëŸ¬: ${r.spoiler ? 'O' : 'X'} | ì‘ì„±ì¼: ${r.createdAt ?? ''}`;

            const body = document.createElement("div");
            body.textContent = r.overall;

            div.appendChild(meta);
            div.appendChild(body);
            listEl.appendChild(div);
        }

        backdrop.classList.add("show");
    }

    function closeModal() {
        document.getElementById("review-modal-backdrop").classList.remove("show");
    }
</script>
</body>
</html>
