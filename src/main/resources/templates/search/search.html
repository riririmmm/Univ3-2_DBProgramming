<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="ko">

<head>
    <meta charset="UTF-8">
    <title>책 검색</title>
    <link rel="stylesheet" th:href="@{/css/search.css}">
</head>
<body>

<header class="topbar">
    <div class="topbar-inner">
        <a class="brand" th:href="@{/}"></a>

        <!-- 비로그인 -->
        <div class="user-area" sec:authorize="isAnonymous()">
            <a th:href="@{/login}">로그인</a>
            <span class="sep">|</span>
            <a th:href="@{/signup}">회원가입</a>
        </div>

        <!-- 로그인 -->
        <div class="user-area" sec:authorize="isAuthenticated()">
            <a th:href="@{/me}" class="nickname-link">
                <span class="nickname" th:text="${loginNickname}">닉네임</span>
            </a>
            <span class="sep">|</span>
            <a th:href="@{/logout}">로그아웃</a>
        </div>
    </div>
</header>

<div class="page">
    <h1>책 검색</h1>

    <!-- 검색 박스 -->
    <div th:replace="search/search-form :: searchForm"></div>

    <!-- 검색 결과 영역 -->
    <div th:replace="search/search-result :: searchResult"></div>
</div>

<script>
    const $q = document.getElementById('q');
    const $btn = document.getElementById('searchBtn');
    const $results = document.getElementById('results');

    function renderResults(list) {
        $results.innerHTML = '';

        if (!list || list.length === 0) {
            const p = document.createElement('div');
            p.className = 'helper';
            p.textContent = '검색 결과가 없습니다.';
            $results.appendChild(p);
            return;
        }

        const book_list = document.createElement('div');
        book_list.className = 'results-list';

        list.forEach(b => {
            const div = document.createElement('div');
            div.className = 'book-card';

            // ✅ 카드 전체 클릭 → 상세 페이지 이동
            div.addEventListener('click', () => {
                location.href = '/books/' + b.isbn13;
            });

            const img = document.createElement('img');
            img.src = b.coverUrl || '';
            img.alt = b.title || '';

            const info = document.createElement('div');
            info.className = 'book-info';

            const title = document.createElement('div');
            title.className = 'book-title';
            title.textContent = b.title || '(제목 없음)';

            const meta = document.createElement('div');
            meta.className = 'book-meta';
            meta.textContent =
                (b.authors && b.authors.length > 0 ? b.authors.join(', ') : '')
                + (b.publisher ? ` | ${b.publisher}` : '');

            const desc = document.createElement('div');
            desc.className = 'book-desc';
            desc.textContent = b.description || '';

            info.appendChild(title);
            info.appendChild(meta);
            info.appendChild(desc);

            div.appendChild(img);
            div.appendChild(info);
            book_list.appendChild(div);
        });

        $results.appendChild(book_list);
    }

    async function doSearch() {
        const q = $q.value.trim();
        if (!q) return;

        $results.innerHTML = '<div class="helper">검색 중...</div>';

        try {
            const res = await fetch(`/api/books/search?q=${encodeURIComponent(q)}&size=10`);
            if (!res.ok) {
                $results.innerHTML = `<div class="helper">검색 실패: ${res.status}</div>`;
                return;
            }
            const data = await res.json();
            renderResults(data);
        } catch (e) {
            console.error(e);
            $results.innerHTML = '<div class="helper">오류 발생</div>';
        }
    }

    $btn.addEventListener('click', doSearch);
    $q.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') doSearch();
    });
</script>
</body>
</html>
